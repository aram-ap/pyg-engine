name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  python-tests:
    name: Python Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsfml-dev \
          cmake \
          build-essential

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install sfml cmake

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel cmake pybind11
        pip install pytest pytest-cov pytest-mock

    - name: Build extension
      run: |
        python setup.py build_ext --inplace -j 4

    - name: Run Python tests
      run: |
        pytest tests/ -v --cov=pyg --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: python
        name: python-${{ matrix.python-version }}

  cpp-tests:
    name: C++ Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-type: [Debug, Release]

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsfml-dev \
          cmake \
          build-essential

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install sfml cmake

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install pybind11
      run: |
        python -m pip install --upgrade pip
        pip install pybind11

    - name: Configure CMake
      run: |
        mkdir -p build_tests
        cd build_tests
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}

    - name: Build C++ tests
      run: |
        cd build_tests
        cmake --build . --target cpp_tests -j 4

    - name: Run C++ tests
      run: |
        cd build_tests
        ./cpp_tests --gtest_output=xml:test_results.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cpp-test-results-${{ matrix.os }}-${{ matrix.build-type }}
        path: build_tests/test_results.xml

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Run Ruff linter
      run: |
        ruff check pyg/ tests/ --output-format=github

    - name: Run Ruff formatter check
      run: |
        ruff format --check pyg/ tests/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [python-tests, cpp-tests]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libsfml-dev \
          cmake \
          build-essential

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel cmake pybind11
        pip install pytest pytest-cov pytest-mock

    - name: Build extension
      run: |
        python setup.py build_ext --inplace -j 4

    - name: Run integration tests
      run: |
        pytest tests/ -v -m integration

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [python-tests, cpp-tests, lint, integration-tests]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "Python tests: ${{ needs.python-tests.result }}"
        echo "C++ tests: ${{ needs.cpp-tests.result }}"
        echo "Lint: ${{ needs.lint.result }}"
        echo "Integration tests: ${{ needs.integration-tests.result }}"
        
        if [ "${{ needs.python-tests.result }}" != "success" ] || \
           [ "${{ needs.cpp-tests.result }}" != "success" ] || \
           [ "${{ needs.lint.result }}" != "success" ] || \
           [ "${{ needs.integration-tests.result }}" != "success" ]; then
          echo "Some tests failed!"
          exit 1
        fi
        
        echo "All tests passed!"

